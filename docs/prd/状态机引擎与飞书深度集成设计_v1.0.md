# 状态机引擎与飞书深度集成设计 v1.0

**版本**: v1.0
**日期**: 2026-02-07
**作者**: Lyra (BitFantasy COO)
**项目**: nimo 平台

---

## 一、架构总览

### 1.1 双通道架构

```
┌──────────────────────────────────────┐
│           nimo 业务引擎               │
│    （状态机 + 业务逻辑 + 数据库）      │
│         唯一的数据真相源               │
└─────────┬──────────────┬─────────────┘
          │              │
    ┌─────▼─────┐  ┌─────▼─────┐
    │  飞书通道   │  │ MCP/API通道│
    │  （人操作） │  │（Agent操作）│
    └───────────┘  └───────────┘
```

### 1.2 核心原则

1. **业务引擎是唯一真相源** — 所有状态、数据存在nimo数据库
2. **飞书是人的交互层** — 审批、任务、会议、通知
3. **MCP是Agent的交互层** — 自动审核、数据分析、批量操作
4. **智能路由** — 根据规则决定走飞书通道还是MCP通道

---

## 二、状态机引擎设计

### 2.1 核心概念

| 概念 | 说明 | 示例 |
|------|------|------|
| State（状态） | 业务对象当前所处的状态 | 待指派、待处理、进行中、待审批、已完成 |
| Event（事件） | 触发状态转换的动作 | 开始任务、完成任务、审批通过、审批驳回 |
| Transition（转换） | 从一个状态到另一个状态的规则 | 进行中 + 完成任务 → 待审批 |
| Condition（条件） | 转换时的判断条件 | 评审结果=通过 |
| Action（动作） | 转换时自动执行的操作 | 创建飞书任务、发送通知 |
| Guard（守卫） | 阻止转换的条件 | 前置任务未完成则不能开始 |

### 2.2 数据模型

```sql
-- 状态机定义（可复用于PLM/ERP/WMS）
CREATE TABLE state_machine_definitions (
    id UUID PRIMARY KEY,
    name VARCHAR(100) NOT NULL,           -- 如: plm_task, purchase_order
    description TEXT,
    initial_state VARCHAR(50) NOT NULL,
    states JSONB NOT NULL,                -- 状态列表及属性
    created_at TIMESTAMP DEFAULT NOW()
);

-- 状态转换规则
CREATE TABLE state_transitions (
    id UUID PRIMARY KEY,
    machine_id UUID REFERENCES state_machine_definitions(id),
    from_state VARCHAR(50) NOT NULL,
    to_state VARCHAR(50) NOT NULL,
    event VARCHAR(100) NOT NULL,          -- 触发事件名
    condition JSONB,                      -- 条件表达式（可选）
    actions JSONB,                        -- 触发的动作列表
    priority INT DEFAULT 0,              -- 优先级（同事件多条规则时）
    description TEXT
);

-- 状态转换日志（审计追溯）
CREATE TABLE state_transition_logs (
    id UUID PRIMARY KEY,
    entity_type VARCHAR(50) NOT NULL,     -- plm_task, purchase_order 等
    entity_id UUID NOT NULL,
    from_state VARCHAR(50),
    to_state VARCHAR(50) NOT NULL,
    event VARCHAR(100) NOT NULL,
    event_data JSONB,                     -- 事件携带的数据
    triggered_by VARCHAR(64),             -- 操作人（user_id 或 agent_id）
    triggered_by_type VARCHAR(20),        -- user | agent | system
    actions_executed JSONB,               -- 执行了哪些动作
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 2.3 PLM任务状态机

```
                    ┌──────────┐
                    │  待指派   │
                    └────┬─────┘
                  指派执行人
                    ┌────▼─────┐
                    │  待处理   │ ←────── 回退
                    └────┬─────┘         │
                   开始任务              │
                    ┌────▼─────┐         │
                    │  进行中   │         │
                    └────┬─────┘         │
                   提交完成              │
              ┌─────────┴──────────┐    │
              │                    │    │
    ┌─────────▼──┐      ┌─────────▼──┐ │
    │ 已完成      │      │ 待审批     │ │
    │(无需审批)   │      │(需要审批)   │ │
    └─────────────┘      └─────┬──────┘ │
                          审批结果       │
                    ┌──────┴──────┐     │
              ┌─────▼────┐  ┌────▼────┐│
              │ 已完成    │  │ 已驳回  │┘
              │(审批通过) │  │(回退)   │
              └──────────┘  └─────────┘
```

### 2.4 动作类型

| 动作类型 | 说明 | 参数 |
|---------|------|------|
| feishu_create_task | 创建飞书任务 | assignee, summary, due_date |
| feishu_update_task | 更新飞书任务状态 | task_id, status |
| feishu_create_approval | 发起飞书审批 | approval_code, form_data, approvers |
| feishu_create_meeting | 创建飞书会议 | title, attendees, attachments |
| feishu_send_card | 发送飞书消息卡片 | chat_id, card_content |
| notify_users | 通知用户 | user_ids, message |
| start_dependent_tasks | 启动依赖任务 | - (自动检查依赖) |
| rollback_tasks | 回退指定任务 | task_codes, target_state |
| assign_roles | 从审批数据指派角色 | approval_data_mapping |
| trigger_mcp | 触发MCP工具调用 | tool_name, params |

---

## 三、飞书深度集成方案

### 3.1 飞书API清单

| 能力 | API | 用途 |
|-----|-----|------|
| 审批定义 | POST /approval/v4/approvals | 创建审批模板 |
| 审批实例 | POST /approval/v4/instances | 发起审批 |
| 审批查询 | GET /approval/v4/instances/{id} | 获取审批结果和表单数据 |
| 审批回调 | 事件订阅 | 审批完成/驳回通知 |
| 任务创建 | POST /task/v2/tasks | 创建飞书任务 |
| 任务更新 | PATCH /task/v2/tasks/{id} | 更新任务状态 |
| 日历会议 | POST /calendar/v4/calendars/{id}/events | 创建会议 |
| 消息卡片 | POST /im/v1/messages | 发送交互式卡片 |
| 云文档 | 文件上传/分享 | 图纸等文件管理 |

### 3.2 审批模板自动创建

流程模板发布时，自动为需要审批的里程碑创建飞书审批定义：

```
模板编辑：配置"立项评审"任务
  · 需要审批: ✅
  · 审批表单字段:
    - 评审结论 (单选: 通过/有条件通过/不通过)
    - 电子工程师 (人员选择)
    - 结构工程师 (人员选择)
    - 光学工程师 (人员选择)
    - 评审意见 (多行文本)
    - 附件 (文件上传)
  · 审批流程: 项目经理 → 部门负责人
           ↓
模板发布时自动调用飞书API创建审批定义
  · 保存 approval_code 到模板任务
```

### 3.3 审批数据回流

```
飞书审批完成 → webhook 回调 nimo
  │
  ├─ 解析审批结果
  │   · 评审结论 = "通过"
  │   · 电子工程师 = ou_xxx (飞书用户ID)
  │   · 结构工程师 = ou_yyy
  │
  ├─ 状态机处理
  │   · 立项评审任务 → 已完成
  │   · 检查依赖 → EVT阶段任务可启动
  │
  ├─ 角色指派
  │   · 从审批表单获取用户ID
  │   · 指派到EVT阶段对应任务
  │
  └─ 飞书任务创建
      · 自动给电子工程师创建飞书任务
      · 自动给结构工程师创建飞书任务
```

### 3.4 会议自动创建

评审任务开始时自动创建飞书会议：

```
评审任务状态 → 进行中
  │
  └─ 自动创建飞书会议
      · 标题: "[项目名] - 立项评审会"
      · 参会人: 项目经理 + 相关评审人
      · 描述: 自动附上项目概要、相关文档链接
      · 时间: 任务计划日期
```

---

## 四、分阶段角色指派设计

### 4.1 阶段-角色映射

模板中每个阶段定义需要的角色：

```sql
CREATE TABLE template_phase_roles (
    id UUID PRIMARY KEY,
    template_id UUID NOT NULL,
    phase VARCHAR(20) NOT NULL,           -- CONCEPT, EVT, DVT, PVT, MP
    role_code VARCHAR(50) NOT NULL,       -- pm, ee, me, oe, sw_engineer
    role_name VARCHAR(100) NOT NULL,      -- 项目经理, 电子工程师, 结构工程师
    is_required BOOLEAN DEFAULT true,
    trigger_task_code VARCHAR(50),        -- 哪个任务完成后触发指派（里程碑code）
    UNIQUE(template_id, phase, role_code)
);
```

### 4.2 指派流程

```
项目创建 → 只指派CONCEPT阶段角色（PM、用研）
    ↓
CONCEPT任务执行
    ↓
立项评审（里程碑）→ 触发审批
    · 审批表单中指派EVT角色
    ↓
审批通过 → 系统自动:
    · 读取审批表单中的用户ID
    · 指派到EVT阶段所有任务
    · 为已指派的任务创建飞书任务
    · EVT阶段正式启动
```

---

## 五、任务回退机制

### 5.1 回退配置

模板中里程碑任务可配置回退选项：

```sql
CREATE TABLE template_task_outcomes (
    id UUID PRIMARY KEY,
    template_id UUID NOT NULL,
    task_code VARCHAR(50) NOT NULL,       -- 评审任务的code
    outcome_code VARCHAR(50) NOT NULL,    -- pass, fail_redo, fail_change
    outcome_name VARCHAR(100) NOT NULL,   -- 通过, 不通过-重做, 不通过-换方案
    rollback_to_task_code VARCHAR(50),    -- 回退到哪个任务（null表示不回退）
    rollback_cascade BOOLEAN DEFAULT false, -- 是否级联回退后续任务
    sort_order INT DEFAULT 0
);
```

### 5.2 回退流程

```
打样件评审 → 结果="不通过-重做"
    │
    ├─ rollback_to = "供应商打样"
    ├─ 供应商打样任务 → 状态重置为"待处理"
    ├─ 打样件评审任务 → 状态重置为"待处理"
    ├─ 记录回退日志（第N次回退，原因）
    └─ 飞书通知打样负责人："打样评审未通过，请重新打样"
```

---

## 六、智能路由设计

### 6.1 路由规则

```sql
CREATE TABLE routing_rules (
    id UUID PRIMARY KEY,
    entity_type VARCHAR(50) NOT NULL,     -- plm_task, purchase_order
    event VARCHAR(100) NOT NULL,
    condition JSONB,                      -- 路由条件
    channel VARCHAR(20) NOT NULL,         -- feishu | mcp | auto
    priority INT DEFAULT 0,
    description TEXT
);
```

### 6.2 路由示例

| 场景 | 条件 | 路由 |
|------|------|------|
| BOM审核 | 物料数 < 20 且无新物料 | → Agent自动审核(MCP) |
| BOM审核 | 有新物料或金额 > 10万 | → 人工审核(飞书审批) |
| 采购审批 | 金额 < 5000 且供应商A级 | → Agent自动审批(MCP) |
| 采购审批 | 金额 ≥ 5000 | → 飞书审批流 |
| 设计评审 | 任何 | → 飞书会议 + 审批(必须人做) |

---

## 七、开发计划

### Phase 1: 状态机引擎（后端核心）

**文件**: `internal/shared/engine/`

| 文件 | 说明 |
|------|------|
| state_machine.go | 状态机核心逻辑 |
| transition.go | 状态转换处理 |
| action_executor.go | 动作执行器 |
| event_bus.go | 事件总线 |
| models.go | 数据模型 |
| repository.go | 数据访问 |

**交付**: 可运行的状态机引擎，支持状态转换、条件判断、动作触发、日志记录。

### Phase 2: 飞书集成增强

**文件**: `internal/shared/feishu/`

| 文件 | 说明 |
|------|------|
| approval.go | 审批定义创建、实例创建、结果查询 |
| task.go | 飞书任务创建、更新 |
| meeting.go | 会议创建 |
| webhook.go | 事件回调处理 |
| card.go | 消息卡片模板 |

**交付**: 完整的飞书API封装 + webhook接收端点。

### Phase 3: PLM改造

| 改动 | 说明 |
|------|------|
| 后端-任务状态流转 | 接入状态机引擎 |
| 后端-审批对接 | 审批创建、回调处理、数据回流 |
| 后端-角色指派 | 分阶段指派 + 审批数据指派 |
| 后端-任务回退 | 回退机制 + 日志 |
| 前端-模板编辑 | 增加审批配置、评审结果配置 |
| 前端-创建项目 | 分阶段角色指派 |
| 前端-项目详情 | 智能操作按钮、评审对话框 |

### Phase 4: 智能路由

- 简单规则引擎
- Agent/人工自动分流

---

## 八、技术规格

### 8.1 Webhook端点

```
POST /api/v1/webhooks/feishu/approval  — 审批事件回调
POST /api/v1/webhooks/feishu/task      — 任务事件回调
```

### 8.2 新增API

```
POST   /api/v1/projects/{id}/tasks/{taskId}/start      — 开始任务
POST   /api/v1/projects/{id}/tasks/{taskId}/complete    — 完成任务
POST   /api/v1/projects/{id}/tasks/{taskId}/review      — 提交评审结果
POST   /api/v1/projects/{id}/tasks/{taskId}/rollback    — 回退任务
POST   /api/v1/projects/{id}/phases/{phase}/assign      — 阶段角色指派
GET    /api/v1/projects/{id}/tasks/{taskId}/history      — 任务操作历史
```

### 8.3 MCP新增工具

```
plm_start_task          — 开始任务
plm_complete_task       — 完成任务（增强版）
plm_submit_review       — 提交评审结果
plm_assign_phase_roles  — 指派阶段角色
plm_get_task_history    — 获取任务历史
plm_auto_review         — Agent自动审核
```

---

**文档状态**: 待确认
**下一步**: CEO确认后开始Phase 1开发
