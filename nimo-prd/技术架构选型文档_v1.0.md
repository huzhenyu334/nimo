# nimo智能眼镜 PLM+ERP 技术架构选型文档 v1.0

> 文档版本：1.0
> 更新日期：2026-02-05
> 编写：OpenClaw AI

---

## 一、技术选型总览

### 1.1 选型原则

| 原则 | 说明 |
|-----|------|
| **小团队友好** | 20人团队，优先选择学习曲线低、社区活跃的技术 |
| **快速迭代** | 支持敏捷开发，从原型到生产环境部署周期短 |
| **飞书优先** | 深度集成飞书生态，复用飞书基础能力 |
| **云原生** | 容器化部署，支持弹性扩缩容 |
| **成本可控** | 优先开源方案，避免商业授权费用 |
| **国产化兼容** | 支持信创环境部署（可选） |

### 1.2 技术栈全景图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              客户端层                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   Web端     │  │  飞书小程序  │  │  移动H5    │  │  飞书工作台  │    │
│  │ React 18   │  │  原生组件    │  │ 响应式     │  │  应用嵌入   │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              网关层                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    APISIX / Kong Gateway                         │   │
│  │  • 统一入口          • 限流熔断          • 认证鉴权              │   │
│  │  • 路由转发          • 日志采集          • 灰度发布              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        ▼                           ▼                           ▼
┌───────────────────┐   ┌───────────────────┐   ┌───────────────────────┐
│     PLM 服务群     │   │    共享服务       │   │      ERP 服务群       │
│    (Go + Gin)     │   │  (Go + Python)    │   │ (Python + FastAPI)   │
├───────────────────┤   ├───────────────────┤   ├───────────────────────┤
│ • product-svc     │   │ • user-svc (Go)   │   │ • supplier-svc       │
│ • bom-svc         │   │ • integration-svc │   │ • procurement-svc    │
│ • project-svc     │   │   (Python)        │   │ • inventory-svc      │
│ • doc-svc         │   │ • notification-svc│   │ • manufacturing-svc  │
│ • ecn-svc         │   │ • file-svc        │   │ • sales-svc          │
│ • test-svc        │   │                   │   │ • service-svc        │
│                   │   │                   │   │ • finance-svc        │
└───────────────────┘   └───────────────────┘   └───────────────────────┘
        │                           │                           │
        └───────────────────────────┼───────────────────────────┘
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              数据层                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐  │
│  │ PostgreSQL   │  │    Redis     │  │   MinIO      │  │ RabbitMQ   │  │
│  │  主数据库    │  │  缓存/会话   │  │  文件存储    │  │  消息队列  │  │
│  │             │  │              │  │              │  │            │  │
│  │ • 用户数据   │  │ • JWT缓存   │  │ • 设计图纸   │  │ • 异步任务 │  │
│  │ • 业务数据   │  │ • 热点数据   │  │ • BOM附件    │  │ • 事件驱动 │  │
│  │ • 交易数据   │  │ • 分布式锁   │  │ • 报告文档   │  │ • 系统集成 │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            基础设施层                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐  │
│  │ Kubernetes   │  │ GitLab CI/CD │  │ Prometheus   │  │   ELK      │  │
│  │  容器编排    │  │  持续交付    │  │  + Grafana   │  │  日志分析  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 二、前端技术栈

### 2.1 核心框架选型

| 技术 | 版本 | 选型理由 | 备选方案 |
|-----|------|---------|---------|
| **React** | 18.x | • Hooks生态成熟<br>• 社区资源丰富<br>• TypeScript支持好<br>• 飞书组件库支持 | Vue 3 (如团队更熟悉) |
| **TypeScript** | 5.x | • 类型安全，减少运行时错误<br>• IDE智能提示<br>• 重构友好 | JavaScript (不推荐) |
| **Ant Design** | 5.x | • 企业级UI组件库<br>• 设计规范完善<br>• 国际化支持<br>• 与飞书视觉风格接近 | Arco Design (字节系) |
| **Vite** | 5.x | • 极速HMR<br>• 原生ESM<br>• 构建速度快 | Webpack 5 |

### 2.2 状态管理

| 技术 | 用途 | 选型理由 |
|-----|------|---------|
| **Zustand** | 全局状态 | • 极简API，学习成本低<br>• 支持中间件<br>• 体积小(~1KB) |
| **React Query (TanStack Query)** | 服务端状态 | • 自动缓存与同步<br>• 请求去重<br>• 乐观更新支持 |
| **Jotai** | 原子状态(可选) | • 适合复杂表单<br>• 精细化更新 |

### 2.3 专业组件

| 组件 | 版本 | 用途 | 备选 |
|-----|------|------|-----|
| **DHTMLX Gantt** | 8.x | 甘特图(项目管理) | Frappe Gantt(免费但功能少) |
| **AG Grid** | 31.x | 高性能表格 | Ant Design Table(数据量小时) |
| **react-flow** | 11.x | BOM关系图、流程图 | G6(蚂蚁系) |
| **ECharts** | 5.x | 数据可视化 | Chart.js |
| **TinyMCE** | 6.x | 富文本编辑 | Quill |

### 2.4 前端项目结构

```
frontend/
├── apps/
│   ├── plm/                    # PLM前端应用
│   │   ├── src/
│   │   │   ├── pages/          # 页面组件
│   │   │   ├── components/     # 业务组件
│   │   │   ├── hooks/          # 自定义Hooks
│   │   │   ├── stores/         # Zustand stores
│   │   │   ├── services/       # API调用
│   │   │   └── utils/          # 工具函数
│   │   └── vite.config.ts
│   │
│   ├── erp/                    # ERP前端应用
│   │   └── (同上结构)
│   │
│   └── portal/                 # 统一门户(工作台)
│
├── packages/
│   ├── ui/                     # 共享UI组件库
│   ├── hooks/                  # 共享Hooks
│   ├── utils/                  # 共享工具
│   └── types/                  # 共享类型定义
│
├── package.json                # Monorepo配置
├── pnpm-workspace.yaml         # pnpm workspace
└── turbo.json                  # Turborepo配置
```

### 2.5 前端构建配置

**pnpm-workspace.yaml:**
```yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

**turbo.json:**
```json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {},
    "test": {
      "dependsOn": ["build"]
    }
  }
}
```

---

## 三、后端技术栈

### 3.1 语言选型对比

| 维度 | Go | Python | Node.js | Java |
|-----|-----|--------|---------|------|
| **性能** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **开发效率** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| **并发能力** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **飞书SDK** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **学习曲线** | 中 | 低 | 低 | 高 |
| **运维成本** | 低 | 中 | 中 | 高 |
| **招聘难度** | 中 | 低 | 低 | 低 |

### 3.2 最终选型

**双语言策略：Go + Python**

| 系统 | 语言 | 框架 | 理由 |
|-----|------|------|------|
| **PLM核心服务** | Go 1.22 | Gin | • BOM计算需要高性能<br>• 并发处理项目任务<br>• 编译型语言，部署简单 |
| **ERP业务服务** | Python 3.12 | FastAPI | • 业务逻辑复杂，开发效率优先<br>• 数据分析/报表生态丰富<br>• 飞书SDK支持最好 |
| **集成服务** | Python 3.12 | FastAPI | • 飞书开放平台SDK成熟<br>• 快速对接第三方 |
| **用户服务** | Go 1.22 | Gin | • 认证高频调用，性能敏感<br>• JWT处理Go更高效 |

### 3.3 Go技术栈详解

```
Go 服务技术栈
├── 框架层
│   ├── Gin 1.9             # Web框架
│   ├── gRPC 1.60           # 服务间通信(内部)
│   └── Swagger/OpenAPI     # API文档
│
├── 数据层
│   ├── GORM 1.25           # ORM框架
│   ├── sqlx                # 复杂SQL场景
│   ├── go-redis/redis 9    # Redis客户端
│   └── mongo-driver 1.13   # MongoDB客户端
│
├── 工具层
│   ├── wire                # 依赖注入
│   ├── viper               # 配置管理
│   ├── zap                 # 结构化日志
│   ├── validator/v10       # 参数校验
│   └── jwt-go              # JWT处理
│
└── 测试
    ├── testify             # 断言库
    ├── mockery             # Mock生成
    └── go-sqlmock          # 数据库Mock
```

**Go服务标准目录结构：**
```
service-name/
├── cmd/
│   └── server/
│       └── main.go         # 入口
├── internal/
│   ├── config/             # 配置
│   ├── handler/            # HTTP处理器
│   ├── service/            # 业务逻辑
│   ├── repository/         # 数据访问
│   ├── model/              # 数据模型
│   └── middleware/         # 中间件
├── pkg/                    # 可复用包
├── api/
│   └── openapi.yaml        # API定义
├── configs/
│   └── config.yaml         # 配置文件
├── Dockerfile
├── Makefile
└── go.mod
```

### 3.4 Python技术栈详解

```
Python 服务技术栈
├── 框架层
│   ├── FastAPI 0.109       # Web框架
│   ├── Uvicorn             # ASGI服务器
│   ├── Pydantic 2.x        # 数据校验
│   └── python-multipart    # 文件上传
│
├── 数据层
│   ├── SQLAlchemy 2.0      # ORM框架
│   ├── asyncpg             # PostgreSQL异步驱动
│   ├── redis.asyncio       # Redis异步客户端
│   └── motor               # MongoDB异步客户端
│
├── 工具层
│   ├── Celery 5.3          # 异步任务队列
│   ├── APScheduler         # 定时任务
│   ├── structlog           # 结构化日志
│   ├── python-jose         # JWT处理
│   └── httpx               # HTTP客户端
│
├── 飞书集成
│   ├── lark-oapi           # 飞书官方SDK
│   └── feishu-python-sdk   # 社区SDK(备选)
│
└── 测试
    ├── pytest              # 测试框架
    ├── pytest-asyncio      # 异步测试
    ├── factory-boy         # 测试数据工厂
    └── httpx               # API测试
```

**Python服务标准目录结构：**
```
service-name/
├── app/
│   ├── __init__.py
│   ├── main.py             # FastAPI应用入口
│   ├── config.py           # 配置
│   ├── dependencies.py     # 依赖注入
│   ├── api/
│   │   ├── __init__.py
│   │   └── v1/
│   │       ├── __init__.py
│   │       ├── router.py   # 路由汇总
│   │       └── endpoints/  # 各端点
│   ├── core/
│   │   ├── security.py     # 安全相关
│   │   └── exceptions.py   # 异常定义
│   ├── models/             # SQLAlchemy模型
│   ├── schemas/            # Pydantic模型
│   ├── services/           # 业务逻辑
│   ├── repositories/       # 数据访问
│   └── utils/              # 工具函数
├── tests/
├── alembic/                # 数据库迁移
├── Dockerfile
├── pyproject.toml          # 项目配置(Poetry)
└── requirements.txt        # 依赖(备用)
```

---

## 四、数据库设计

### 4.1 数据库选型

| 数据库 | 版本 | 用途 | 部署方式 |
|-------|------|------|---------|
| **PostgreSQL** | 16.x | 主数据库 | 主从复制 |
| **Redis** | 7.x | 缓存/会话/分布式锁 | 哨兵模式 |
| **MinIO** | RELEASE | 文件对象存储 | 单节点(初期) |
| **RabbitMQ** | 3.13 | 消息队列 | 镜像队列 |

### 4.2 为什么选 PostgreSQL 而不是 MySQL

| 维度 | PostgreSQL | MySQL |
|-----|------------|-------|
| **JSON支持** | ⭐⭐⭐⭐⭐ JSONB原生索引 | ⭐⭐⭐ JSON函数有限 |
| **复杂查询** | ⭐⭐⭐⭐⭐ CTE、窗口函数 | ⭐⭐⭐⭐ 支持但优化器弱 |
| **扩展性** | ⭐⭐⭐⭐⭐ 插件生态丰富 | ⭐⭐⭐ 扩展有限 |
| **数据完整性** | ⭐⭐⭐⭐⭐ 严格约束 | ⭐⭐⭐⭐ 宽松模式 |
| **全文搜索** | ⭐⭐⭐⭐ 内置支持 | ⭐⭐⭐ 需外部方案 |
| **地理信息** | ⭐⭐⭐⭐⭐ PostGIS | ⭐⭐⭐ 基础支持 |
| **运维成本** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

**选择PostgreSQL的关键理由：**
1. BOM数据结构复杂，JSONB存储灵活属性
2. ERP需要复杂报表查询，PostgreSQL查询优化器更强
3. 递归CTE支持BOM层级展开
4. 将来可能用TimescaleDB做时序数据(库存变动、传感器数据)

### 4.3 数据库分库策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          PostgreSQL 实例                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │ nimo_user   │  │ nimo_plm    │  │ nimo_erp    │  │ nimo_log    │   │
│  │             │  │             │  │             │  │             │   │
│  │ • users     │  │ • products  │  │ • suppliers │  │ • audit_log │   │
│  │ • roles     │  │ • bom       │  │ • orders    │  │ • op_log    │   │
│  │ • perms     │  │ • projects  │  │ • inventory │  │ • api_log   │   │
│  │ • orgs      │  │ • documents │  │ • finance   │  │             │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.4 Redis使用规范

| 用途 | Key格式 | 过期时间 | 示例 |
|-----|--------|---------|------|
| 用户会话 | `session:{user_id}` | 24h | `session:u_123456` |
| JWT Token | `token:{jti}` | 与JWT过期同步 | `token:abc123` |
| 热点数据缓存 | `cache:{module}:{id}` | 5min-1h | `cache:product:p_001` |
| 分布式锁 | `lock:{resource}:{id}` | 30s | `lock:bom:b_001` |
| 幂等性 | `idempotent:{key}` | 24h | `idempotent:order_create_xxx` |
| 限流计数 | `ratelimit:{api}:{user}` | 1min | `ratelimit:api_export:u_123` |

### 4.5 数据库连接配置

**Go服务连接池配置：**
```go
// config/database.go
type DatabaseConfig struct {
    Host            string        `yaml:"host"`
    Port            int           `yaml:"port"`
    Database        string        `yaml:"database"`
    Username        string        `yaml:"username"`
    Password        string        `yaml:"password"`
    MaxOpenConns    int           `yaml:"max_open_conns"`    // 最大连接数
    MaxIdleConns    int           `yaml:"max_idle_conns"`    // 最大空闲连接
    ConnMaxLifetime time.Duration `yaml:"conn_max_lifetime"` // 连接最大生命周期
    ConnMaxIdleTime time.Duration `yaml:"conn_max_idle_time"`// 空闲连接最大时间
}

// 推荐配置
var defaultDBConfig = DatabaseConfig{
    MaxOpenConns:    50,
    MaxIdleConns:    10,
    ConnMaxLifetime: 30 * time.Minute,
    ConnMaxIdleTime: 5 * time.Minute,
}
```

**Python服务连接池配置：**
```python
# app/core/database.py
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "postgresql+asyncpg://user:pass@host:5432/db"

engine = create_async_engine(
    DATABASE_URL,
    pool_size=20,           # 连接池大小
    max_overflow=10,        # 超出pool_size后最多创建的连接
    pool_timeout=30,        # 获取连接超时
    pool_recycle=1800,      # 连接回收时间(秒)
    pool_pre_ping=True,     # 连接前检查有效性
)

AsyncSessionLocal = sessionmaker(
    engine, class_=AsyncSession, expire_on_commit=False
)
```

---

## 五、消息队列与异步任务

### 5.1 RabbitMQ队列设计

```
Exchange: nimo.direct (直连交换机)
├── Queue: plm.task.created       # PLM任务创建通知
├── Queue: plm.bom.changed        # BOM变更事件
├── Queue: plm.ecn.approved       # ECN审批完成
├── Queue: erp.order.created      # 采购订单创建
├── Queue: erp.inventory.alert    # 库存预警
└── Queue: integration.feishu     # 飞书通知队列

Exchange: nimo.topic (主题交换机)
├── plm.project.*.status          # 项目状态变更
├── erp.*.created                 # 各模块创建事件
└── *.audit.log                   # 审计日志

Exchange: nimo.dlx (死信交换机)
└── Queue: dlx.retry              # 失败重试队列
```

### 5.2 事件定义规范

```json
{
  "event_id": "evt_20260205_abc123",
  "event_type": "plm.bom.released",
  "timestamp": "2026-02-05T19:45:00+08:00",
  "source": "bom-service",
  "data": {
    "bom_id": "BOM-2026-001",
    "product_id": "PRD-NIMO-001",
    "version": "1.0",
    "released_by": "u_123456"
  },
  "metadata": {
    "trace_id": "trace_xxx",
    "correlation_id": "corr_yyy"
  }
}
```

### 5.3 Celery任务配置(Python服务)

```python
# app/core/celery.py
from celery import Celery

celery_app = Celery(
    "nimo_erp",
    broker="amqp://user:pass@rabbitmq:5672/nimo",
    backend="redis://redis:6379/1",
)

celery_app.conf.update(
    task_serializer="json",
    accept_content=["json"],
    result_serializer="json",
    timezone="Asia/Shanghai",
    enable_utc=True,
    task_routes={
        "app.tasks.reports.*": {"queue": "reports"},
        "app.tasks.sync.*": {"queue": "sync"},
        "app.tasks.notification.*": {"queue": "notification"},
    },
    task_default_retry_delay=60,          # 重试延迟60秒
    task_max_retries=3,                   # 最大重试3次
    worker_prefetch_multiplier=4,         # 预取数量
    task_acks_late=True,                  # 任务完成后确认
    task_reject_on_worker_lost=True,      # Worker丢失时拒绝任务
)
```

---

## 六、API网关与服务通信

### 6.1 API网关选型

| 网关 | 优点 | 缺点 | 推荐场景 |
|-----|------|------|---------|
| **APISIX** | • 国产开源，社区活跃<br>• 动态配置，无需重启<br>• 插件丰富<br>• 性能优秀 | • 相对较新<br>• 文档偏技术向 | ✅ 推荐 |
| Kong | • 成熟稳定<br>• 生态丰富 | • 企业功能收费<br>• Lua技术栈 | 大型企业 |
| Traefik | • K8s原生集成<br>• 自动发现 | • 复杂场景支持弱 | 简单场景 |

### 6.2 APISIX配置示例

**路由配置：**
```yaml
# apisix/config.yaml
routes:
  # PLM服务路由
  - uri: /api/v1/plm/*
    upstream:
      type: roundrobin
      nodes:
        "plm-product-svc:8002": 1
        "plm-bom-svc:8003": 1
    plugins:
      jwt-auth: {}
      limit-req:
        rate: 100
        burst: 50
        key: consumer_name
      
  # ERP服务路由
  - uri: /api/v1/erp/*
    upstream:
      type: roundrobin
      nodes:
        "erp-supplier-svc:8101": 1
        "erp-procurement-svc:8102": 1
    plugins:
      jwt-auth: {}
```

### 6.3 服务间通信

| 场景 | 协议 | 框架 |
|-----|------|------|
| 前端→后端 | HTTP/REST | OpenAPI 3.0 |
| Go服务↔Go服务 | gRPC | protobuf |
| Go服务↔Python服务 | HTTP/REST | OpenAPI 3.0 |
| 异步通信 | AMQP | RabbitMQ |

**gRPC Proto定义示例：**
```protobuf
// proto/user/v1/user.proto
syntax = "proto3";

package user.v1;

service UserService {
  rpc GetUser(GetUserRequest) returns (GetUserResponse);
  rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse);
}

message GetUserRequest {
  string user_id = 1;
}

message GetUserResponse {
  User user = 1;
}

message User {
  string id = 1;
  string name = 2;
  string email = 3;
  string feishu_user_id = 4;
  repeated string roles = 5;
}
```

---

## 七、容器与部署

### 7.1 Docker镜像构建

**Go服务Dockerfile：**
```dockerfile
# Build stage
FROM golang:1.22-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o server ./cmd/server

# Runtime stage
FROM alpine:3.19
RUN apk --no-cache add ca-certificates tzdata
WORKDIR /app
COPY --from=builder /app/server .
COPY --from=builder /app/configs ./configs
ENV TZ=Asia/Shanghai
EXPOSE 8000
CMD ["./server"]
```

**Python服务Dockerfile：**
```dockerfile
# Build stage
FROM python:3.12-slim AS builder
WORKDIR /app
RUN pip install poetry
COPY pyproject.toml poetry.lock ./
RUN poetry export -f requirements.txt --output requirements.txt --without-hashes

# Runtime stage
FROM python:3.12-slim
WORKDIR /app
COPY --from=builder /app/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY app ./app
ENV TZ=Asia/Shanghai
EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 7.2 Kubernetes部署

**Deployment示例：**
```yaml
# k8s/plm/product-service.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: plm-product-service
  namespace: nimo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: plm-product-service
  template:
    metadata:
      labels:
        app: plm-product-service
    spec:
      containers:
        - name: product-service
          image: registry.example.com/nimo/plm-product-service:v1.0.0
          ports:
            - containerPort: 8002
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8002
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 8002
            initialDelaySeconds: 5
            periodSeconds: 5
          envFrom:
            - configMapRef:
                name: plm-config
            - secretRef:
                name: plm-secrets
---
apiVersion: v1
kind: Service
metadata:
  name: plm-product-service
  namespace: nimo
spec:
  selector:
    app: plm-product-service
  ports:
    - port: 8002
      targetPort: 8002
```

### 7.3 环境配置

| 环境 | 用途 | 基础设施 | 部署方式 |
|-----|------|---------|---------|
| **local** | 本地开发 | Docker Desktop | docker-compose |
| **dev** | 开发联调 | 单节点服务器 | docker-compose |
| **test** | 测试环境 | 单节点服务器 | K3s |
| **staging** | 预发布 | 与生产同配置 | Kubernetes |
| **prod** | 生产环境 | Kubernetes集群 | Kubernetes + GitOps |

**docker-compose.yaml (开发环境)：**
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: nimo
      POSTGRES_PASSWORD: nimo123
      POSTGRES_DB: nimo_dev
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: nimo
      RABBITMQ_DEFAULT_PASS: nimo123

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data

volumes:
  postgres_data:
  minio_data:
```

---

## 八、监控与可观测性

### 8.1 监控技术栈

| 组件 | 用途 | 部署方式 |
|-----|------|---------|
| **Prometheus** | 指标采集 | Kubernetes Operator |
| **Grafana** | 指标可视化 | Helm Chart |
| **Loki** | 日志聚合 | Helm Chart |
| **Jaeger** | 链路追踪 | All-in-one(初期) |
| **AlertManager** | 告警管理 | 与Prometheus配套 |

### 8.2 关键指标(SLI)

**API服务指标：**
```
# 请求延迟
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# 错误率
sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))

# 吞吐量
sum(rate(http_requests_total[5m]))
```

**业务指标：**
| 指标 | 阈值 | 告警级别 |
|-----|------|---------|
| API P95延迟 | > 500ms | Warning |
| API P99延迟 | > 1s | Critical |
| 错误率 | > 1% | Warning |
| 错误率 | > 5% | Critical |
| 数据库连接池使用率 | > 80% | Warning |
| 消息队列积压 | > 1000 | Warning |

### 8.3 日志规范

**结构化日志格式：**
```json
{
  "timestamp": "2026-02-05T19:45:00.123+08:00",
  "level": "INFO",
  "service": "plm-product-service",
  "trace_id": "abc123",
  "span_id": "def456",
  "user_id": "u_123",
  "message": "Product created successfully",
  "data": {
    "product_id": "PRD-001",
    "product_name": "NIMO Air Pro"
  }
}
```

---

## 九、安全设计

### 9.1 认证方案

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           认证流程                                       │
└─────────────────────────────────────────────────────────────────────────┘

    用户                 前端                网关               用户服务              飞书
     │                   │                  │                   │                   │
     │  1. 点击飞书登录   │                  │                   │                   │
     │ ─────────────────>│                  │                   │                   │
     │                   │  2. 重定向到飞书  │                   │                   │
     │ <────────────────────────────────────────────────────────────────────────────>│
     │                   │                  │                   │                   │
     │  3. 授权完成，带code│                 │                   │                   │
     │ ─────────────────>│                  │                   │                   │
     │                   │ 4. POST /auth/callback               │                   │
     │                   │ ────────────────>│ ─────────────────>│                   │
     │                   │                  │                   │ 5. 换取access_token│
     │                   │                  │                   │ ─────────────────>│
     │                   │                  │                   │ <─────────────────│
     │                   │                  │                   │ 6. 获取用户信息    │
     │                   │                  │                   │ ─────────────────>│
     │                   │                  │                   │ <─────────────────│
     │                   │                  │                   │ 7. 创建/更新用户  │
     │                   │                  │ <─────────────────│ 8. 生成JWT       │
     │                   │ <────────────────│                   │                   │
     │ <─────────────────│ 9. 返回JWT       │                   │                   │
     │  10. 存储token    │                  │                   │                   │
```

### 9.2 JWT Token设计

```json
{
  "header": {
    "alg": "RS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "u_123456",                    // 用户ID
    "iss": "nimo-auth",                   // 签发者
    "aud": ["nimo-plm", "nimo-erp"],      // 受众
    "exp": 1707177600,                    // 过期时间
    "iat": 1707091200,                    // 签发时间
    "jti": "jwt_abc123",                  // JWT ID
    "name": "张三",
    "email": "zhangsan@bitfantasy.com",
    "feishu_uid": "ou_xxx",
    "roles": ["plm_admin", "erp_viewer"],
    "perms": ["product:read", "product:write", "bom:read"]
  }
}
```

### 9.3 API安全

| 安全措施 | 实现方式 |
|---------|---------|
| HTTPS | TLS 1.3，HSTS |
| 认证 | JWT Bearer Token |
| 授权 | RBAC + 数据权限 |
| 限流 | 令牌桶算法，100 req/s/user |
| 防重放 | 请求签名 + 时间戳 + Nonce |
| 敏感数据 | AES-256-GCM加密存储 |
| SQL注入 | ORM参数化查询 |
| XSS | 输入过滤 + CSP |
| CSRF | SameSite Cookie + Token |

---

## 十、开发规范

### 10.1 Git分支策略

```
main (生产分支)
 │
 ├── release/v1.0.0 (发布分支)
 │
 └── develop (开发分支)
      │
      ├── feature/PLM-001-product-module
      ├── feature/ERP-002-supplier-module
      └── bugfix/PLM-003-bom-calculation
```

### 10.2 提交信息规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type类型：**
- `feat`: 新功能
- `fix`: Bug修复
- `docs`: 文档
- `style`: 代码格式
- `refactor`: 重构
- `test`: 测试
- `chore`: 构建/工具

**示例：**
```
feat(plm): 实现BOM多级展开功能

- 支持BOM递归查询
- 添加缓存优化
- 新增展开层级参数

Closes PLM-123
```

### 10.3 代码审查要点

| 审查项 | 检查内容 |
|-------|---------|
| 功能正确性 | 是否满足需求，边界条件处理 |
| 代码质量 | 可读性，DRY原则，命名规范 |
| 安全性 | 输入校验，权限检查，敏感信息 |
| 性能 | N+1查询，大数据量处理，缓存使用 |
| 测试 | 单元测试覆盖，边界测试 |
| 文档 | API文档，关键逻辑注释 |

---

## 十一、技术风险与应对

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 双语言栈增加复杂度 | 运维、调试困难 | • 统一日志格式<br>• 标准化部署流程<br>• 文档规范 |
| 飞书API限流 | 批量操作失败 | • 请求队列<br>• 指数退避重试<br>• 缓存飞书数据 |
| PostgreSQL单点 | 数据库不可用 | • 主从复制<br>• 自动故障转移<br>• 定期备份 |
| 消息丢失 | 业务数据不一致 | • 消息持久化<br>• 确认机制<br>• 死信队列 |
| 团队技术栈不熟悉 | 开发效率低 | • 技术培训<br>• 代码模板<br>• 结对编程 |

---

## 十二、技术选型决策记录(ADR)

### ADR-001: 数据库选择PostgreSQL

**状态：** 已采纳

**背景：** 需要选择主数据库，候选MySQL和PostgreSQL

**决策：** 选择PostgreSQL 16

**理由：**
1. BOM数据需要JSONB存储灵活属性
2. 递归CTE支持BOM层级展开
3. 将来可扩展TimescaleDB做时序分析

**后果：**
- 正面：查询能力强，扩展性好
- 负面：团队需要学习PostgreSQL特性

---

### ADR-002: 后端采用Go+Python双语言

**状态：** 已采纳

**背景：** 需要平衡性能和开发效率

**决策：** PLM核心服务用Go，ERP业务服务用Python

**理由：**
1. PLM的BOM计算需要高性能
2. ERP业务逻辑复杂，Python开发效率高
3. 飞书SDK在Python生态更成熟

**后果：**
- 正面：各取所长，性能和效率兼顾
- 负面：需要维护两套技术栈

---

### ADR-003: 不使用MongoDB

**状态：** 已采纳

**背景：** 早期设计考虑MongoDB存储BOM版本和文档

**决策：** 统一使用PostgreSQL，不引入MongoDB

**理由：**
1. PostgreSQL JSONB能满足灵活存储需求
2. 减少运维复杂度
3. 事务一致性更好保证
4. 团队学习成本降低

**后果：**
- 正面：架构简化，运维成本降低
- 负面：极端场景下灵活性略差(可接受)

---

## 附录A：技术栈版本清单

| 类别 | 技术 | 版本 | 备注 |
|-----|------|------|------|
| **前端** | React | 18.2.x | |
| | TypeScript | 5.3.x | |
| | Ant Design | 5.12.x | |
| | Vite | 5.0.x | |
| | pnpm | 8.x | 包管理 |
| **后端(Go)** | Go | 1.22.x | |
| | Gin | 1.9.x | |
| | GORM | 1.25.x | |
| | go-redis | 9.x | |
| **后端(Python)** | Python | 3.12.x | |
| | FastAPI | 0.109.x | |
| | SQLAlchemy | 2.0.x | |
| | Pydantic | 2.5.x | |
| | Celery | 5.3.x | |
| **数据库** | PostgreSQL | 16.x | |
| | Redis | 7.2.x | |
| | RabbitMQ | 3.13.x | |
| **存储** | MinIO | RELEASE.2024-01 | |
| **基础设施** | Docker | 24.x | |
| | Kubernetes | 1.29.x | |
| | APISIX | 3.8.x | |
| | GitLab | 16.x | CI/CD |
| **监控** | Prometheus | 2.48.x | |
| | Grafana | 10.2.x | |
| | Loki | 2.9.x | |
| | Jaeger | 1.52.x | |

---

## 附录B：参考资源

### 官方文档
- [Go官方文档](https://go.dev/doc/)
- [FastAPI官方文档](https://fastapi.tiangolo.com/)
- [PostgreSQL官方文档](https://www.postgresql.org/docs/16/)
- [飞书开放平台](https://open.feishu.cn/document/)
- [APISIX官方文档](https://apisix.apache.org/docs/)

### 推荐书籍
- 《Go语言高级编程》
- 《Python Cookbook》
- 《PostgreSQL修炼之道》
- 《微服务架构设计模式》
- 《Kubernetes权威指南》

---

*文档结束*
