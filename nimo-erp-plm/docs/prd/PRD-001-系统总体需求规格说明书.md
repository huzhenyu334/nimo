# Nimo智能眼镜ERP+PLM系统 - 产品需求规格说明书

| 文档属性 | 值 |
|---------|---|
| **文档编号** | PRD-001 |
| **版本** | 1.0.0 |
| **状态** | 草案 |
| **密级** | 内部公开 |
| **创建日期** | 2026-02-05 |
| **最后更新** | 2026-02-05 |
| **作者** | 系统架构组 |
| **审核人** | 待定 |
| **批准人** | 待定 |

---

## 修订历史

| 版本 | 日期 | 作者 | 修订内容 |
|-----|------|-----|---------|
| 1.0.0 | 2026-02-05 | 系统架构组 | 初始版本 |

---

## 目录

1. [引言](#1-引言)
2. [系统概述](#2-系统概述)
3. [用户与角色](#3-用户与角色)
4. [功能需求](#4-功能需求)
5. [非功能需求](#5-非功能需求)
6. [数据需求](#6-数据需求)
7. [外部接口需求](#7-外部接口需求)
8. [约束与假设](#8-约束与假设)
9. [验收标准](#9-验收标准)
10. [附录](#10-附录)

---

## 1. 引言

### 1.1 编写目的

本文档是Nimo智能眼镜ERP+PLM系统的产品需求规格说明书（PRD），旨在：

1. 明确系统的业务目标和范围
2. 定义系统的功能需求和非功能需求
3. 作为系统设计、开发、测试的基准文档
4. 作为项目验收的依据

**目标读者：** 产品经理、系统架构师、开发工程师、测试工程师、项目经理

### 1.2 项目背景

#### 1.2.1 公司简介

| 属性 | 描述 |
|-----|------|
| **公司名称** | Bitfantasy（比特幻境） |
| **品牌名称** | Nimo |
| **主营产品** | AI智能眼镜 |
| **团队规模** | ~20人（以研发为主） |
| **战略愿景** | 以OpenClaw数字员工为核心，打造AI驱动的精益组织 |

#### 1.2.2 产品特点

Nimo智能眼镜是面向消费者的AI智能眼镜产品：

- **近视功能**：支持配镜，不改变传统眼镜外观
- **极致轻量**：极简设计，长时间佩戴无负担
- **显示功能**：单色MicroLED显示，信息提示为主
- **交互方式**：麦克风输入，无摄像头和喇叭
- **平台架构**：镜腿（含光机、电池、芯片）为平台，镜框快速迭代

#### 1.2.3 业务模式

```
研发立项 → 产品设计 → 硬件/软件研发 → 打样验证 → 供应链采购 
    → 外协代工 → 品质检验 → 市场营销 → 代理商分销 → 眼镜门店零售
```

#### 1.2.4 项目驱动因素

| 驱动因素 | 描述 |
|---------|------|
| **快速迭代** | 需支持一年内推出数十款SKU |
| **供应链透明** | 需实现物料、成本、交期的全链路可视 |
| **数据驱动** | 需建立以BOM为核心的单一数据源 |
| **协同效率** | 需深度集成飞书，实现任务、审批、通知的一体化 |
| **降本增效** | 需通过数字化降低人力成本，提升运营效率 |

### 1.3 术语与缩写

| 术语/缩写 | 全称 | 定义 |
|----------|-----|------|
| **ERP** | Enterprise Resource Planning | 企业资源计划，管理采购、库存、生产、销售、财务 |
| **PLM** | Product Lifecycle Management | 产品生命周期管理，管理产品从概念到退市的全过程 |
| **BOM** | Bill of Materials | 物料清单，产品所需物料的结构化清单 |
| **EVT** | Engineering Verification Test | 工程验证测试，验证设计可行性 |
| **DVT** | Design Verification Test | 设计验证测试，验证产品设计 |
| **PVT** | Production Verification Test | 生产验证测试，验证生产工艺 |
| **MP** | Mass Production | 批量生产，正式量产阶段 |
| **ECN** | Engineering Change Notice | 工程变更通知 |
| **MRP** | Material Requirements Planning | 物料需求计划 |
| **ATP** | Available to Promise | 可用承诺量 |
| **SKU** | Stock Keeping Unit | 库存量单位，最小库存管理单元 |
| **PN** | Part Number | 物料编码 |
| **PO** | Purchase Order | 采购订单 |
| **PR** | Purchase Request | 采购申请 |
| **WO** | Work Order | 生产工单 |
| **QC** | Quality Control | 质量控制 |
| **IPQC** | In-Process Quality Control | 过程质量控制 |
| **FQC** | Final Quality Control | 最终质量控制 |
| **SSO** | Single Sign-On | 单点登录 |
| **RBAC** | Role-Based Access Control | 基于角色的访问控制 |
| **SLA** | Service Level Agreement | 服务级别协议 |
| **RTO** | Recovery Time Objective | 恢复时间目标 |
| **RPO** | Recovery Point Objective | 恢复点目标 |

### 1.4 参考文档

| 文档编号 | 文档名称 | 版本 |
|---------|---------|-----|
| ARCH-001 | 系统技术架构设计 | 1.0.0 |
| DB-001 | 数据库设计规范 | 1.0.0 |
| API-001 | API接口规范 | 1.0.0 |
| SEC-001 | 安全设计规范 | 1.0.0 |

---

## 2. 系统概述

### 2.1 系统定位

本系统是一套**以BOM为核心枢纽**的集成化企业管理系统，涵盖：

- **PLM域**：产品数据管理、研发项目管理、BOM管理、变更管理
- **ERP域**：采购管理、库存管理、生产管理、销售管理、财务管理、售后管理
- **协同域**：飞书集成、任务协同、审批流程、消息通知

### 2.2 系统目标

#### 2.2.1 业务目标

| 目标 | 指标 | 当前值 | 目标值 |
|-----|------|-------|-------|
| **产品迭代速度** | 年SKU数量 | 10-20款 | 50+款 |
| **BOM准确率** | 一次准确率 | 未知 | >99.5% |
| **订单交付周期** | 平均天数 | 未知 | 缩短40% |
| **库存周转率** | 年周转次数 | 未知 | 提升30% |
| **采购及时率** | 按时到货率 | 未知 | >95% |

#### 2.2.2 技术目标

| 目标 | 指标 | 目标值 |
|-----|------|-------|
| **系统可用性** | Availability | 99.9% |
| **API响应时间** | P95延迟 | <500ms |
| **数据一致性** | 跨服务事务成功率 | >99.99% |
| **并发能力** | 峰值TPS | 1000+ |

### 2.3 系统边界

#### 2.3.1 系统范围内

```
┌─────────────────────────────────────────────────────────────────┐
│                        系统范围                                  │
├─────────────────────────────────────────────────────────────────┤
│  PLM模块                                                        │
│  ├── 产品数据管理（产品、版本、文档）                              │
│  ├── BOM管理（设计BOM、制造BOM、成本BOM、服务BOM）                 │
│  ├── 项目管理（EVT/DVT/PVT/MP阶段、任务、甘特图）                  │
│  └── 变更管理（ECN申请、影响分析、审批）                           │
├─────────────────────────────────────────────────────────────────┤
│  ERP模块                                                        │
│  ├── 采购管理（供应商、询价、采购订单、到货）                       │
│  ├── 库存管理（入库、出库、盘点、库位、预警）                       │
│  ├── 生产管理（MRP、工单、报工、质检）                             │
│  ├── 销售管理（客户、订单、发货、渠道）                            │
│  ├── 售后管理（服务请求、维修、备件、追溯）                        │
│  └── 财务管理（成本、应收、应付、报表）                            │
├─────────────────────────────────────────────────────────────────┤
│  集成模块                                                        │
│  ├── 飞书集成（SSO、组织架构、任务、审批、通知）                    │
│  ├── 报表分析（BI看板、数据导出）                                 │
│  └── 系统管理（权限、配置、日志、监控）                            │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.3.2 系统范围外

| 模块 | 说明 | 对接方式 |
|-----|------|---------|
| **CAD/EDA软件** | 硬件设计工具 | 文件导入 |
| **MES系统** | 代工厂执行系统 | API对接（二期） |
| **电商平台** | 天猫、京东等 | API对接（二期） |
| **物流系统** | 快递公司系统 | API对接 |
| **银行系统** | 支付结算 | 手工对账 |

### 2.4 系统架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户接入层                               │
│  飞书扫码登录 │ 飞书工作台 │ Web管理端 │ 移动端H5 │ OpenAPI      │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                        API网关层                                 │
│            Kong：路由、限流、认证、监控、日志                      │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                       微服务层                                   │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │用户服务 │ │PLM服务  │ │ERP服务  │ │集成服务 │ │报表服务 │   │
│  │  :8001  │ │  :8002  │ │  :8003  │ │  :8004  │ │  :8005  │   │
│  │   Go    │ │   Go    │ │ Python  │ │ Python  │ │ Python  │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                       数据层                                     │
│  PostgreSQL │ MongoDB │ Redis │ Elasticsearch │ MinIO │ Doris  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 用户与角色

### 3.1 用户来源

所有用户账号来源于**飞书组织架构**，系统不维护独立用户注册流程。

用户生命周期：
- **入职**：飞书入职 → 自动同步到系统 → 分配角色权限
- **调岗**：飞书调岗 → 自动同步部门 → 权限自动更新
- **离职**：飞书离职 → 自动禁用系统账号 → 保留历史数据

### 3.2 角色定义

#### 3.2.1 系统角色列表

| 角色代码 | 角色名称 | 飞书映射 | 说明 |
|---------|---------|---------|------|
| `SUPER_ADMIN` | 超级管理员 | 飞书管理员 | 全部权限 |
| `DEPT_ADMIN` | 部门管理员 | 部门主管 | 部门内全部权限 |
| `PM` | 项目经理 | - | 项目管理权限 |
| `RD_MANAGER` | 研发经理 | - | 研发管理权限 |
| `RD_ENGINEER` | 研发工程师 | - | 研发执行权限 |
| `PURCHASE_MANAGER` | 采购经理 | - | 采购管理权限 |
| `PURCHASER` | 采购员 | - | 采购执行权限 |
| `WAREHOUSE_MANAGER` | 仓库主管 | - | 库存管理权限 |
| `WAREHOUSE_KEEPER` | 仓管员 | - | 库存执行权限 |
| `PRODUCTION_MANAGER` | 生产经理 | - | 生产管理权限 |
| `PRODUCTION_WORKER` | 生产员 | - | 生产执行权限 |
| `QC_MANAGER` | 质量经理 | - | 质量管理权限 |
| `QC_INSPECTOR` | 质检员 | - | 质检执行权限 |
| `SALES_MANAGER` | 销售经理 | - | 销售管理权限 |
| `SALES_REP` | 销售代表 | - | 销售执行权限 |
| `FINANCE_MANAGER` | 财务经理 | - | 财务管理权限 |
| `ACCOUNTANT` | 会计 | - | 财务执行权限 |
| `SERVICE_MANAGER` | 售后经理 | - | 售后管理权限 |
| `SERVICE_REP` | 售后专员 | - | 售后执行权限 |
| `VIEWER` | 只读用户 | - | 仅查看权限 |

#### 3.2.2 权限矩阵（示例）

| 功能模块 | 超级管理员 | 项目经理 | 研发工程师 | 采购员 | 仓管员 |
|---------|:--------:|:------:|:--------:|:-----:|:-----:|
| 产品管理-创建 | ✓ | ✓ | ✓ | - | - |
| 产品管理-查看 | ✓ | ✓ | ✓ | ✓ | ✓ |
| BOM管理-创建 | ✓ | ✓ | ✓ | - | - |
| BOM管理-审批 | ✓ | ✓ | - | - | - |
| 采购订单-创建 | ✓ | - | - | ✓ | - |
| 库存-入库 | ✓ | - | - | - | ✓ |
| 库存-出库 | ✓ | - | - | - | ✓ |

### 3.3 数据权限规则

| 规则类型 | 规则描述 | 示例 |
|---------|---------|------|
| **全局** | 可访问所有数据 | 超级管理员 |
| **部门** | 仅访问本部门及下级部门数据 | 部门主管 |
| **个人** | 仅访问自己创建/负责的数据 | 普通员工 |
| **项目** | 仅访问参与项目的数据 | 项目成员 |

---

## 4. 功能需求

### 4.1 模块总览

```
系统功能
├── FM-01 用户与权限管理
├── FM-02 PLM-产品数据管理
├── FM-03 PLM-BOM管理
├── FM-04 PLM-项目任务管理
├── FM-05 PLM-变更管理
├── FM-06 ERP-供应商管理
├── FM-07 ERP-采购管理
├── FM-08 ERP-库存管理
├── FM-09 ERP-生产管理
├── FM-10 ERP-销售管理
├── FM-11 ERP-售后管理
├── FM-12 ERP-财务管理
├── FM-13 飞书集成
├── FM-14 报表与分析
└── FM-15 系统管理
```

---

### 4.2 FM-01 用户与权限管理

#### 4.2.1 功能概述

| 属性 | 描述 |
|-----|------|
| **模块编号** | FM-01 |
| **模块名称** | 用户与权限管理 |
| **优先级** | P0（核心） |
| **依赖模块** | 飞书集成（FM-13） |

#### 4.2.2 功能清单

| 功能编号 | 功能名称 | 优先级 | 说明 |
|---------|---------|:------:|------|
| FM-01-01 | 飞书扫码登录 | P0 | 用户通过飞书扫码完成登录 |
| FM-01-02 | 飞书账密登录 | P0 | 用户通过飞书账号密码登录 |
| FM-01-03 | 免密登录 | P1 | 已登录飞书客户端的用户自动登录 |
| FM-01-04 | 会话管理 | P0 | JWT令牌发放、刷新、失效 |
| FM-01-05 | 用户信息同步 | P0 | 从飞书实时获取用户信息 |
| FM-01-06 | 组织架构同步 | P0 | 从飞书同步部门、层级关系 |
| FM-01-07 | 角色管理 | P0 | 创建、编辑、删除角色 |
| FM-01-08 | 权限配置 | P0 | 为角色分配功能权限和数据权限 |
| FM-01-09 | 用户角色分配 | P0 | 为用户分配一个或多个角色 |
| FM-01-10 | 操作日志 | P0 | 记录所有用户操作 |
| FM-01-11 | 登录日志 | P0 | 记录所有登录行为 |

#### 4.2.3 详细需求

##### FM-01-01 飞书扫码登录

**前置条件：**
- 用户已在飞书组织内
- 用户飞书APP已登录

**业务流程：**
```
1. 用户访问系统登录页
2. 系统展示飞书登录二维码
3. 用户使用飞书APP扫码
4. 飞书返回授权码到系统回调地址
5. 系统用授权码换取access_token
6. 系统用access_token获取用户信息
7. 系统检查用户是否存在：
   - 存在：更新最后登录时间
   - 不存在：创建用户记录（仅存储飞书ID）
8. 系统生成JWT令牌
9. 系统缓存会话到Redis
10. 返回令牌，用户登录成功
```

**输入输出：**

| 参数 | 方向 | 类型 | 必填 | 说明 |
|-----|------|-----|:----:|------|
| redirect_uri | 入参 | String | 否 | 登录后跳转地址 |
| access_token | 出参 | String | 是 | JWT访问令牌 |
| refresh_token | 出参 | String | 是 | JWT刷新令牌 |
| expires_in | 出参 | Integer | 是 | 令牌有效期（秒） |
| user_info | 出参 | Object | 是 | 用户基本信息 |

**异常处理：**

| 异常码 | 异常描述 | 处理方式 |
|-------|---------|---------|
| AUTH_001 | 飞书授权失败 | 提示用户重试 |
| AUTH_002 | 用户不在组织内 | 提示联系管理员 |
| AUTH_003 | 用户已被禁用 | 提示账号已禁用 |
| AUTH_004 | 飞书API超时 | 自动重试3次 |

---

### 4.3 FM-02 PLM-产品数据管理

#### 4.3.1 功能概述

| 属性 | 描述 |
|-----|------|
| **模块编号** | FM-02 |
| **模块名称** | 产品数据管理 |
| **优先级** | P0（核心） |
| **依赖模块** | FM-01 用户与权限 |

#### 4.3.2 功能清单

| 功能编号 | 功能名称 | 优先级 | 说明 |
|---------|---------|:------:|------|
| FM-02-01 | 产品创建 | P0 | 创建新产品记录 |
| FM-02-02 | 产品编辑 | P0 | 修改产品基本信息 |
| FM-02-03 | 产品查询 | P0 | 多条件查询产品列表 |
| FM-02-04 | 产品详情 | P0 | 查看产品完整信息 |
| FM-02-05 | 版本管理 | P0 | 管理产品版本（硬件/软件/固件） |
| FM-02-06 | 文档管理 | P1 | 管理产品相关文档（图纸、规格书等） |
| FM-02-07 | 产品状态流转 | P0 | 产品生命周期状态管理 |
| FM-02-08 | 产品分类管理 | P1 | 管理产品分类树 |
| FM-02-09 | 产品导入导出 | P2 | 批量导入导出产品数据 |

#### 4.3.3 数据模型

##### 产品主数据

| 字段名 | 字段类型 | 必填 | 说明 |
|-------|---------|:----:|------|
| id | UUID | 是 | 产品唯一标识 |
| sku | VARCHAR(50) | 是 | 产品SKU编码，唯一 |
| name | VARCHAR(200) | 是 | 产品名称 |
| name_en | VARCHAR(200) | 否 | 产品英文名称 |
| category_id | UUID | 是 | 产品分类ID |
| product_type | ENUM | 是 | 产品类型：glasses/accessory/module |
| status | ENUM | 是 | 产品状态（见状态机） |
| current_hw_version | VARCHAR(20) | 否 | 当前硬件版本 |
| current_sw_version | VARCHAR(20) | 否 | 当前软件版本 |
| current_fw_version | VARCHAR(20) | 否 | 当前固件版本 |
| description | TEXT | 否 | 产品描述 |
| specifications | JSONB | 否 | 产品规格参数 |
| thumbnail_url | VARCHAR(500) | 否 | 产品缩略图URL |
| feishu_doc_url | VARCHAR(500) | 否 | 飞书文档链接 |
| created_by | VARCHAR(64) | 是 | 创建人（飞书用户ID） |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |
| updated_by | VARCHAR(64) | 是 | 更新人 |
| updated_at | TIMESTAMPTZ | 是 | 更新时间 |

##### 产品状态机

```
                    ┌─────────┐
                    │  draft  │  草稿
                    └────┬────┘
                         │ 提交评审
                         ▼
                    ┌─────────┐
                    │   evt   │  EVT阶段
                    └────┬────┘
                         │ EVT评审通过
                         ▼
                    ┌─────────┐
                    │   dvt   │  DVT阶段
                    └────┬────┘
                         │ DVT评审通过
                         ▼
                    ┌─────────┐
                    │   pvt   │  PVT阶段
                    └────┬────┘
                         │ PVT评审通过
                         ▼
                    ┌─────────┐
               ┌────│   mp    │  量产阶段
               │    └────┬────┘
               │         │ 停产
               │         ▼
               │    ┌─────────┐
               │    │   eol   │  停产
               │    └─────────┘
               │
               │ 质量问题/设计变更
               ▼
          ┌─────────┐
          │ on_hold │  暂停
          └─────────┘
```

---

### 4.4 FM-03 PLM-BOM管理

#### 4.4.1 功能概述

| 属性 | 描述 |
|-----|------|
| **模块编号** | FM-03 |
| **模块名称** | BOM管理 |
| **优先级** | P0（核心） |
| **依赖模块** | FM-02 产品数据管理 |

**BOM是系统的核心枢纽**，所有业务流程围绕BOM展开。

#### 4.4.2 BOM类型定义

| BOM类型 | 代码 | 用途 | 负责角色 |
|--------|------|------|---------|
| **设计BOM** | design | 研发阶段使用，包含设计物料 | 研发工程师 |
| **制造BOM** | manufacturing | 生产阶段使用，包含实际采购物料 | 生产工程师 |
| **成本BOM** | cost | 财务核算使用，包含成本信息 | 财务人员 |
| **服务BOM** | service | 售后阶段使用，包含可维修部件 | 售后工程师 |

#### 4.4.3 功能清单

| 功能编号 | 功能名称 | 优先级 | 说明 |
|---------|---------|:------:|------|
| FM-03-01 | BOM创建 | P0 | 创建新BOM版本 |
| FM-03-02 | BOM编辑 | P0 | 编辑BOM物料清单 |
| FM-03-03 | BOM版本管理 | P0 | 管理BOM版本（v1.0, v1.1...） |
| FM-03-04 | BOM类型转换 | P0 | 设计BOM→制造BOM转换 |
| FM-03-05 | BOM比对 | P1 | 比较两个BOM版本的差异 |
| FM-03-06 | BOM审批 | P0 | BOM发布审批流程 |
| FM-03-07 | BOM成本计算 | P0 | 自动计算BOM物料成本 |
| FM-03-08 | 替代料管理 | P1 | 管理物料替代关系 |
| FM-03-09 | BOM导入导出 | P1 | Excel导入导出 |
| FM-03-10 | BOM影响分析 | P0 | 分析BOM变更的影响范围 |
| FM-03-11 | BOM结构树 | P0 | 可视化BOM层级结构 |
| FM-03-12 | 反查BOM | P1 | 查询物料被哪些BOM使用 |

#### 4.4.4 数据模型

##### BOM版本表

| 字段名 | 字段类型 | 必填 | 说明 |
|-------|---------|:----:|------|
| id | UUID | 是 | BOM版本唯一标识 |
| product_id | UUID | 是 | 关联产品ID |
| version | VARCHAR(20) | 是 | 版本号（如v1.0, v1.1） |
| bom_type | ENUM | 是 | BOM类型（design/manufacturing/cost/service） |
| status | ENUM | 是 | 状态（draft/pending/approved/released/obsolete） |
| parent_version_id | UUID | 否 | 基于哪个版本创建 |
| effective_date | DATE | 否 | 生效日期 |
| expiry_date | DATE | 否 | 失效日期 |
| total_cost | DECIMAL(12,4) | 否 | BOM总成本 |
| mongo_doc_id | VARCHAR(100) | 是 | MongoDB文档ID（存储详细结构） |
| created_by | VARCHAR(64) | 是 | 创建人 |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |
| approved_by | VARCHAR(64) | 否 | 审批人 |
| approved_at | TIMESTAMPTZ | 否 | 审批时间 |
| released_by | VARCHAR(64) | 否 | 发布人 |
| released_at | TIMESTAMPTZ | 否 | 发布时间 |
| remarks | TEXT | 否 | 备注 |

**约束：** `UNIQUE(product_id, version, bom_type)`

##### BOM结构（MongoDB文档）

```json
{
  "_id": "bom_uuid_xxx",
  "bom_version_id": "uuid-xxx",
  "product_id": "uuid-xxx",
  "version": "1.0",
  "bom_type": "manufacturing",
  "items": [
    {
      "level": 1,
      "item_no": 1,
      "material_id": "uuid-xxx",
      "material_code": "MAT-MCU-001",
      "material_name": "主控芯片RTL8720",
      "specification": "QFN-48, 2.4GHz",
      "quantity": 1,
      "unit": "pcs",
      "unit_price": 15.50,
      "currency": "CNY",
      "amount": 15.50,
      "supplier_id": "uuid-xxx",
      "supplier_name": "瑞昱半导体",
      "lead_time_days": 30,
      "moq": 1000,
      "substitutes": [
        {
          "material_id": "uuid-xxx",
          "material_code": "MAT-MCU-002",
          "priority": 1,
          "remark": "国产替代"
        }
      ],
      "reference_designator": "U1",
      "mounting_type": "SMT",
      "remarks": "主控制芯片",
      "children": []
    },
    {
      "level": 1,
      "item_no": 2,
      "material_id": "uuid-xxx",
      "material_code": "MAT-OPT-001",
      "material_name": "光学模组",
      "specification": "0.23\" MicroLED",
      "quantity": 1,
      "unit": "pcs",
      "unit_price": 180.00,
      "currency": "CNY",
      "amount": 180.00,
      "children": [
        {
          "level": 2,
          "item_no": 1,
          "material_code": "MAT-OPT-001-01",
          "material_name": "MicroLED芯片",
          "quantity": 1
        },
        {
          "level": 2,
          "item_no": 2,
          "material_code": "MAT-OPT-001-02",
          "material_name": "波导镜片",
          "quantity": 1
        }
      ]
    }
  ],
  "summary": {
    "total_items": 45,
    "total_cost": 580.75,
    "currency": "CNY",
    "cost_breakdown": {
      "electronic": 320.50,
      "optical": 180.00,
      "mechanical": 65.25,
      "packaging": 15.00
    }
  },
  "attachments": [
    {
      "name": "电路原理图.pdf",
      "url": "minio://bom-docs/xxx.pdf",
      "size": 2456789,
      "uploaded_by": "user_xxx",
      "uploaded_at": "2026-01-30T10:00:00Z"
    }
  ],
  "created_at": "2026-01-30T10:00:00Z",
  "updated_at": "2026-02-01T15:30:00Z"
}
```

#### 4.4.5 BOM状态机

```
          ┌─────────┐
          │  draft  │  草稿
          └────┬────┘
               │ 提交审批
               ▼
          ┌─────────┐
          │ pending │  待审批
          └────┬────┘
              ╱ ╲
    审批通过 ╱   ╲ 审批驳回
            ▼     ▼
     ┌──────────┐  ┌─────────┐
     │ approved │  │  draft  │
     └────┬─────┘  └─────────┘
          │ 发布
          ▼
     ┌──────────┐
     │ released │  已发布
     └────┬─────┘
          │ 废弃
          ▼
     ┌──────────┐
     │ obsolete │  已废弃
     └──────────┘
```

#### 4.4.6 FM-03-10 BOM影响分析（详细）

**触发场景：** BOM变更申请时

**分析维度：**

| 维度 | 分析内容 | 输出 |
|-----|---------|-----|
| **成本影响** | 变更前后物料成本差异 | 成本差异金额、百分比 |
| **库存影响** | 受影响的库存物料 | 物料清单、当前库存量、预估损耗 |
| **在途影响** | 已下单未到货的采购订单 | PO清单、到货日期、处理建议 |
| **生产影响** | 使用该BOM的生产工单 | WO清单、当前状态、处理建议 |
| **供应商影响** | 需要通知的供应商 | 供应商清单、联系方式 |
| **交期影响** | 对交付周期的影响 | 延期天数预估 |

---

### 4.5 FM-04 PLM-项目任务管理

#### 4.5.1 功能概述

| 属性 | 描述 |
|-----|------|
| **模块编号** | FM-04 |
| **模块名称** | 项目任务管理 |
| **优先级** | P0（核心） |
| **依赖模块** | FM-02 产品数据管理、FM-13 飞书集成 |

#### 4.5.2 功能清单

| 功能编号 | 功能名称 | 优先级 | 说明 |
|---------|---------|:------:|------|
| FM-04-01 | 项目创建 | P0 | 创建新产品开发项目 |
| FM-04-02 | 项目模板 | P0 | 管理EVT/DVT/PVT/MP阶段任务模板 |
| FM-04-03 | 从模板创建 | P0 | 基于模板自动生成项目任务 |
| FM-04-04 | 任务管理 | P0 | 任务的CRUD操作 |
| FM-04-05 | 子任务管理 | P0 | 支持多级子任务 |
| FM-04-06 | 任务依赖 | P0 | 设置任务前置依赖关系 |
| FM-04-07 | 任务指派 | P0 | 分配任务负责人 |
| FM-04-08 | 进度更新 | P0 | 更新任务完成进度 |
| FM-04-09 | 甘特图视图 | P0 | 可视化项目时间线 |
| FM-04-10 | 关键路径 | P1 | 自动计算关键路径 |
| FM-04-11 | 里程碑管理 | P0 | 管理项目里程碑 |
| FM-04-12 | 飞书任务同步 | P0 | 双向同步飞书任务 |
| FM-04-13 | 任务提醒 | P0 | 任务到期、延期提醒 |
| FM-04-14 | 项目报表 | P1 | 项目进度报表 |

#### 4.5.3 数据模型

##### 项目表

| 字段名 | 字段类型 | 必填 | 说明 |
|-------|---------|:----:|------|
| id | UUID | 是 | 项目唯一标识 |
| project_code | VARCHAR(50) | 是 | 项目编码，唯一 |
| name | VARCHAR(200) | 是 | 项目名称 |
| product_id | UUID | 否 | 关联产品ID |
| project_type | ENUM | 是 | 项目类型（new_product/enhancement/maintenance） |
| status | ENUM | 是 | 项目状态 |
| current_phase | ENUM | 否 | 当前阶段（evt/dvt/pvt/mp） |
| manager_id | VARCHAR(64) | 是 | 项目经理（飞书用户ID） |
| start_date | DATE | 是 | 计划开始日期 |
| end_date | DATE | 是 | 计划结束日期 |
| actual_start_date | DATE | 否 | 实际开始日期 |
| actual_end_date | DATE | 否 | 实际结束日期 |
| progress | INTEGER | 否 | 整体进度（0-100） |
| description | TEXT | 否 | 项目描述 |
| created_by | VARCHAR(64) | 是 | 创建人 |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |
| updated_at | TIMESTAMPTZ | 是 | 更新时间 |

##### 任务表

| 字段名 | 字段类型 | 必填 | 说明 |
|-------|---------|:----:|------|
| id | UUID | 是 | 任务唯一标识 |
| project_id | UUID | 是 | 所属项目ID |
| task_code | VARCHAR(50) | 是 | 任务编码（如EVT-001） |
| name | VARCHAR(200) | 是 | 任务名称 |
| description | TEXT | 否 | 任务描述 |
| phase | ENUM | 是 | 所属阶段（evt/dvt/pvt/mp） |
| parent_id | UUID | 否 | 父任务ID |
| level | INTEGER | 是 | 层级（1=一级任务，2=子任务...） |
| sort_order | INTEGER | 是 | 排序号 |
| assignee_id | VARCHAR(64) | 否 | 负责人（飞书用户ID） |
| status | ENUM | 是 | 任务状态 |
| priority | ENUM | 是 | 优先级（low/medium/high/critical） |
| progress | INTEGER | 否 | 完成进度（0-100） |
| planned_start | DATE | 是 | 计划开始日期 |
| planned_end | DATE | 是 | 计划结束日期 |
| actual_start | DATE | 否 | 实际开始日期 |
| actual_end | DATE | 否 | 实际结束日期 |
| duration_days | INTEGER | 是 | 计划工期（天） |
| is_milestone | BOOLEAN | 否 | 是否里程碑 |
| deliverables | JSONB | 否 | 交付物清单 |
| feishu_task_id | VARCHAR(100) | 否 | 飞书任务ID |
| created_by | VARCHAR(64) | 是 | 创建人 |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |
| updated_at | TIMESTAMPTZ | 是 | 更新时间 |

##### 任务依赖表

| 字段名 | 字段类型 | 必填 | 说明 |
|-------|---------|:----:|------|
| id | UUID | 是 | 依赖关系ID |
| task_id | UUID | 是 | 任务ID |
| depends_on_task_id | UUID | 是 | 前置任务ID |
| dependency_type | ENUM | 是 | 依赖类型 |
| lag_days | INTEGER | 否 | 延迟天数（默认0） |

**依赖类型说明：**

| 类型 | 全称 | 含义 |
|-----|------|------|
| FS | Finish-to-Start | 前置任务完成后，当前任务才能开始（最常用） |
| SS | Start-to-Start | 前置任务开始后，当前任务才能开始 |
| FF | Finish-to-Finish | 前置任务完成后，当前任务才能完成 |
| SF | Start-to-Finish | 前置任务开始后，当前任务才能完成（少用） |

#### 4.5.4 任务状态机

```
              ┌──────────┐
              │  pending │  待开始
              └────┬─────┘
                   │ 开始日期到达 且 前置任务完成
                   ▼
              ┌──────────────┐
         ┌────│ in_progress  │  进行中
         │    └──────┬───────┘
         │           │
    阻塞 │     ┌─────┴─────┐
         │     │           │
         ▼     ▼           ▼
    ┌─────────┐  ┌──────────┐  ┌───────────┐
    │ blocked │  │  paused  │  │ completed │
    │  阻塞   │  │   暂停   │  │   完成    │
    └────┬────┘  └────┬─────┘  └─────┬─────┘
         │            │              │
         │            │              │ 发现问题
         │            │              ▼
         │            │        ┌──────────┐
         └────────────┴───────►│ reopened │
                               │  重开    │
                               └────┬─────┘
                                    │
                                    ▼
                              ┌───────────┐
                              │ completed │
                              └───────────┘
         
         任意状态
              │ 取消
              ▼
         ┌───────────┐
         │ cancelled │
         │   取消    │
         └───────────┘
```

#### 4.5.5 甘特图计算逻辑

**关键路径算法（CPM）：**

```python
# 伪代码
def calculate_critical_path(tasks, dependencies):
    # 1. 正向计算：计算最早开始/结束时间
    for task in topological_sort(tasks, dependencies):
        task.ES = max(pred.EF + lag for pred in task.predecessors) or project_start
        task.EF = task.ES + task.duration
    
    # 2. 反向计算：计算最晚开始/结束时间
    project_end = max(task.EF for task in tasks)
    for task in reverse_topological_sort(tasks, dependencies):
        task.LF = min(succ.LS - lag for succ in task.successors) or project_end
        task.LS = task.LF - task.duration
    
    # 3. 计算浮动时间
    for task in tasks:
        task.total_float = task.LS - task.ES
        task.is_critical = (task.total_float == 0)
    
    # 4. 返回关键路径
    return [task for task in tasks if task.is_critical]
```

---

### 4.6 FM-13 飞书集成（关键模块）

#### 4.6.1 功能概述

| 属性 | 描述 |
|-----|------|
| **模块编号** | FM-13 |
| **模块名称** | 飞书集成 |
| **优先级** | P0（核心） |
| **依赖模块** | 无（基础模块） |

#### 4.6.2 集成架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        飞书开放平台                              │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ 身份认证 │ │ 通讯录  │ │ 任务API │ │ 审批API │ │ 消息API │   │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘   │
└───────┼───────────┼───────────┼───────────┼───────────┼────────┘
        │           │           │           │           │
        └───────────┴───────────┴─────┬─────┴───────────┘
                                      │
                    ┌─────────────────▼─────────────────┐
                    │          集成服务 :8004           │
                    │  ┌─────────────────────────────┐ │
                    │  │      飞书API适配层          │ │
                    │  ├─────────────────────────────┤ │
                    │  │      数据同步引擎           │ │
                    │  ├─────────────────────────────┤ │
                    │  │      消息队列处理           │ │
                    │  ├─────────────────────────────┤ │
                    │  │      Webhook事件监听        │ │
                    │  └─────────────────────────────┘ │
                    └─────────────────┬─────────────────┘
                                      │
        ┌─────────────┬───────────────┼───────────────┬─────────────┐
        │             │               │               │             │
        ▼             ▼               ▼               ▼             ▼
   ┌─────────┐  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
   │用户服务 │  │PLM服务  │    │ERP服务  │    │RabbitMQ │    │  Redis  │
   └─────────┘  └─────────┘    └─────────┘    └─────────┘    └─────────┘
```

#### 4.6.3 功能清单

| 功能编号 | 功能名称 | 优先级 | 同步方向 | 说明 |
|---------|---------|:------:|:-------:|------|
| FM-13-01 | OAuth认证 | P0 | 飞书→系统 | 飞书OAuth 2.0登录 |
| FM-13-02 | 组织架构同步 | P0 | 飞书→系统 | 部门、员工信息同步 |
| FM-13-03 | 用户信息获取 | P0 | 飞书→系统 | 实时获取用户信息 |
| FM-13-04 | 任务创建同步 | P0 | 系统→飞书 | 系统任务同步到飞书 |
| FM-13-05 | 任务状态同步 | P0 | 双向 | 任务状态双向同步 |
| FM-13-06 | 任务进度同步 | P0 | 双向 | 任务进度双向同步 |
| FM-13-07 | 任务评论同步 | P1 | 双向 | 任务评论双向同步 |
| FM-13-08 | 审批流程触发 | P0 | 系统→飞书 | 触发飞书审批流程 |
| FM-13-09 | 审批结果回写 | P0 | 飞书→系统 | 审批结果同步回系统 |
| FM-13-10 | 消息通知 | P0 | 系统→飞书 | 发送飞书消息通知 |
| FM-13-11 | 事件订阅 | P0 | 飞书→系统 | 订阅飞书事件回调 |
| FM-13-12 | 令牌管理 | P0 | - | 管理飞书access_token |

#### 4.6.4 组织架构同步规则

**同步策略：**

| 同步类型 | 触发方式 | 频率 | 说明 |
|---------|---------|------|------|
| **全量同步** | 定时任务 | 每天凌晨2:00 | 同步全部组织架构 |
| **增量同步** | 事件订阅 | 实时 | 响应飞书变更事件 |
| **手动同步** | 管理员触发 | 按需 | 紧急情况手动触发 |

**同步字段：**

| 飞书字段 | 系统字段 | 同步策略 |
|---------|---------|---------|
| user_id | id | 直接映射 |
| open_id | feishu_open_id | 直接映射 |
| union_id | feishu_union_id | 直接映射 |
| name | - | 不存储，实时获取 |
| email | - | 不存储，实时获取 |
| mobile | - | 不存储，实时获取 |
| department_ids | department_ids | 同步存储 |
| status | is_active | 在职=true，离职=false |

#### 4.6.5 审批流程配置

| 审批场景 | 触发条件 | 审批人规则 | 说明 |
|---------|---------|-----------|------|
| **BOM发布审批** | BOM状态变更为pending | 研发经理→项目经理 | 串行审批 |
| **BOM变更审批** | 提交ECN申请 | 技术评审→成本评审→生产评审 | 串行审批 |
| **采购申请审批** | 提交PR | 部门主管→采购经理 | 金额>10万增加财务审批 |
| **生产工单审批** | 创建WO | 生产主管 | 单人审批 |
| **质量异常审批** | 提交质量异常 | 质量经理→研发经理 | 串行审批 |

---

## 5. 非功能需求

### 5.1 性能需求

| 指标 | 要求 | 测量方法 |
|-----|------|---------|
| **API响应时间** | P95 < 500ms, P99 < 1s | APM监控 |
| **页面加载时间** | 首屏 < 2s | 前端性能监控 |
| **数据库查询** | P95 < 100ms | 慢查询日志 |
| **并发用户数** | 支持100并发用户 | 压力测试 |
| **峰值TPS** | 1000 TPS | 压力测试 |
| **大数据量处理** | 单表1000万行无明显性能下降 | 性能测试 |

### 5.2 可用性需求

| 指标 | 要求 | 说明 |
|-----|------|------|
| **系统可用性** | 99.9% | 每月停机时间<43分钟 |
| **RTO** | < 1小时 | 故障恢复时间 |
| **RPO** | < 5分钟 | 数据恢复点 |
| **计划内停机** | 每月<4小时 | 维护窗口：周日凌晨2-6点 |

### 5.3 安全需求

| 类别 | 要求 |
|-----|------|
| **身份认证** | 飞书OAuth 2.0 + JWT令牌 |
| **传输安全** | 全站HTTPS，TLS 1.3 |
| **数据加密** | 敏感字段AES-256加密存储 |
| **访问控制** | RBAC权限模型 |
| **审计日志** | 所有操作记录，保留2年 |
| **SQL注入防护** | 参数化查询 |
| **XSS防护** | 输入过滤 + CSP策略 |
| **CSRF防护** | Token验证 |
| **速率限制** | 登录5次/分钟，API 100次/分钟 |

### 5.4 可扩展性需求

| 维度 | 要求 |
|-----|------|
| **水平扩展** | 微服务支持多实例部署 |
| **数据库扩展** | 支持读写分离、分库分表 |
| **存储扩展** | 对象存储支持动态扩容 |
| **模块扩展** | 支持新增业务模块而不影响现有功能 |

### 5.5 兼容性需求

| 类别 | 要求 |
|-----|------|
| **浏览器** | Chrome 90+, Firefox 88+, Safari 14+, Edge 90+ |
| **移动端** | iOS 14+, Android 10+ |
| **屏幕分辨率** | 最低1366×768，推荐1920×1080 |
| **飞书版本** | 飞书客户端 5.0+ |

---

## 6. 数据需求

### 6.1 数据架构

```
┌─────────────────────────────────────────────────────────────────┐
│                       数据存储架构                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  PostgreSQL 16  │  │   MongoDB 7.x   │  │    Redis 7.x    │ │
│  │    主数据库     │  │   文档数据库    │  │    缓存/会话    │ │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤ │
│  │ • 用户数据      │  │ • BOM详细结构   │  │ • 会话缓存      │ │
│  │ • 产品数据      │  │ • 设计文档      │  │ • 用户信息缓存  │ │
│  │ • 订单数据      │  │ • 测试报告      │  │ • 权限缓存      │ │
│  │ • 库存数据      │  │ • 审批记录      │  │ • 分布式锁      │ │
│  │ • 财务数据      │  │ • 操作日志      │  │ • 消息队列      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ Elasticsearch 8 │  │     MinIO       │  │  Apache Doris   │ │
│  │    搜索引擎     │  │   对象存储      │  │   数据仓库      │ │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤ │
│  │ • 产品搜索      │  │ • 设计图纸      │  │ • BI报表        │ │
│  │ • BOM搜索       │  │ • 产品图片      │  │ • 数据分析      │ │
│  │ • 日志分析      │  │ • 文档附件      │  │ • 预测分析      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 数据备份策略

| 数据类型 | 备份方式 | 备份频率 | 保留周期 |
|---------|---------|---------|---------|
| **PostgreSQL** | 全量备份 | 每天凌晨3:00 | 30天 |
| **PostgreSQL** | WAL归档 | 实时 | 7天 |
| **MongoDB** | 全量备份 | 每天凌晨3:30 | 30天 |
| **MongoDB** | oplog同步 | 实时 | 7天 |
| **Redis** | RDB快照 | 每小时 | 24小时 |
| **MinIO** | 增量备份 | 每天凌晨4:00 | 90天 |

### 6.3 数据迁移策略

本系统为全新开发，无历史数据迁移需求。

未来如需从其他系统迁移数据，将另行制定迁移方案。

---

## 7. 外部接口需求

### 7.1 飞书开放平台接口

| 接口类别 | API | 用途 |
|---------|-----|------|
| **身份认证** | /authen/v1/oidc/access_token | 获取访问令牌 |
| **身份认证** | /authen/v1/user_info | 获取用户信息 |
| **通讯录** | /contact/v3/departments | 获取部门列表 |
| **通讯录** | /contact/v3/users | 获取用户列表 |
| **任务** | /task/v2/tasks | 任务CRUD |
| **审批** | /approval/v4/instances | 审批实例管理 |
| **消息** | /im/v1/messages | 发送消息 |

### 7.2 内部服务接口

详见《API-001 API接口规范》文档。

---

## 8. 约束与假设

### 8.1 约束条件

| 约束类型 | 约束内容 |
|---------|---------|
| **技术约束** | 必须使用开源技术栈，不使用商业软件 |
| **技术约束** | 必须支持容器化部署（Docker/Kubernetes） |
| **业务约束** | 用户账号必须来自飞书，不支持独立注册 |
| **业务约束** | BOM必须经过审批才能发布 |
| **时间约束** | 第一阶段（PLM核心）需在3个月内上线 |
| **资源约束** | 开发团队8-10人 |

### 8.2 假设前提

| 假设内容 | 影响 |
|---------|------|
| 飞书开放平台API稳定可用 | 如不可用，需设计降级方案 |
| 公司组织架构在飞书中维护完整 | 如不完整，影响权限管理 |
| 代工厂愿意配合系统对接 | 如不配合，生产数据需手工录入 |
| 网络环境稳定 | 如不稳定，影响飞书同步 |

---

## 9. 验收标准

### 9.1 功能验收标准

| 模块 | 验收标准 |
|-----|---------|
| **用户权限** | 飞书扫码登录成功率>99%，权限同步延迟<5秒 |
| **产品管理** | 支持产品全生命周期管理，状态流转正确 |
| **BOM管理** | BOM版本控制正确，成本计算准确，审批流程完整 |
| **项目管理** | 甘特图渲染正确，关键路径计算准确，飞书同步正常 |
| **采购管理** | 采购订单流程完整，库存联动正确 |
| **库存管理** | 出入库准确，库存预警及时 |
| **生产管理** | 工单流程完整，报工数据准确 |
| **飞书集成** | 任务双向同步正常，审批流程正常，消息通知及时 |

### 9.2 非功能验收标准

| 指标 | 验收标准 | 测试方法 |
|-----|---------|---------|
| **响应时间** | P95 < 500ms | 压力测试 |
| **并发能力** | 100并发用户无报错 | 压力测试 |
| **可用性** | 连续运行7天无故障 | 稳定性测试 |
| **安全性** | 通过安全扫描，无高危漏洞 | 安全测试 |

---

## 10. 附录

### 10.1 四阶段开发任务模板

详见《PLM-001 四阶段开发任务模板》文档。

### 10.2 数据库设计

详见《DB-001 数据库设计规范》文档。

### 10.3 API接口规范

详见《API-001 API接口规范》文档。

---

**文档结束**

| 属性 | 值 |
|-----|---|
| **总页数** | - |
| **字数统计** | - |
| **最后更新** | 2026-02-05 |
